{
  "schemaVersion": "1.2",
  "description": "Scans for or installs Microsoft Windows updates. Includes the option to filter on Microsoft Knowledge Base (KB) article IDs.",
  "parameters": {
    "Action": {
      "type": "String",
      "default": "Install",
      "description": "(Optional) Choose an option to scan for Microsoft Windows updates, or scan for and install updates.",
      "allowedValues": [
        "Install",
        "Scan"
      ]
    },
    "AllowReboot": {
      "type": "String",
      "default": "True",
      "description": "(Optional) Specify whether to reboot the instance after installing Windows Updates. The default value is True, which means that instances reboot if any updates are installed. Warning: If you specify False, then some updates might fail to install.",
      "allowedValues": [
        "True",
        "False"
      ]
    },
    "IncludeKbs": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify one or more Microsoft Knowledge Base (KB) article IDs to include. You can install multiple IDs using comma-separated values. Valid formats: KB9876543 or 9876543.",
      "allowedPattern": "(^$)|^((KB){0,1}[0-9]{1,7})(,((KB){0,1}[0-9]{1,7}))*$"
    },
    "ExcludeKbs": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify one or more Microsoft Knowledge Base (KB) article IDs to exclude. You can exclude multiple IDs using comma-separated values. Valid formats: KB9876543 or 9876543.",
      "allowedPattern": "(^$)|^((KB){0,1}[0-9]{1,7})(,((KB){0,1}[0-9]{1,7}))*$"
    },
    "Categories": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify one or more update categories. You can filter categories using comma-separated values. Options: Application, Connectors, CriticalUpdates, DefinitionUpdates, DeveloperKits, Drivers, FeaturePacks, Guidance, Microsoft, SecurityUpdates, ServicePacks, Tools, UpdateRollups, Updates. Valid formats include a single entry, for example: CriticalUpdates. Or you can specify a comma separated list: CriticalUpdates,SecurityUpdates",
      "allowedPattern": "(^$)|^(Application|Connectors|CriticalUpdates|DefinitionUpdates|DeveloperKits|Drivers|FeaturePacks|Guidance|Microsoft|SecurityUpdates|ServicePacks|Tools|UpdateRollups|Updates)(,(Application|Connectors|CriticalUpdates|DefinitionUpdates|DeveloperKits|Drivers|FeaturePacks|Guidance|Microsoft|SecurityUpdates|ServicePacks|Tools|UpdateRollups|Updates))*$"
    },
    "SeverityLevels": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify one or more MSRC severity levels associated with an update. You can filter severity levels using comma-separated values. Options: Critical, Important, Low, Moderate or Unspecified. Valid formats include a single entry, for example: Critical. Or you can specify a comma separated list: Critical,Important,Low.",
      "allowedPattern": "(^$)|^(Critical|Important|Low|Moderate|Unspecified)(,(Critical|Important|Low|Moderate|Unspecified))*$"
    },
    "PublishedDaysOld": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify the number of days since the updates were published. For example, if you specify 10, then the system returns all updates that were published 10 days or more since the updates were released by Microsoft.",
      "allowedPattern": "(^$)|^[0-9]\\d*$"
    },
    "PublishedDateAfter": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify a published-after date. For example, if you specify 01/01/2017, the system returns all updates publish on or after 01/01/2017.",
      "allowedPattern": "(^$)|^(0[1-9]|1[012])[- \\/.](0[1-9]|[12][0-9]|3[01])[- \\/.]((?:19|20)\\d\\d)$"
    },
    "PublishedDateBefore": {
      "type": "String",
      "default": "",
      "description": "(Optional) Specify a published-before date. For example, if you specify 01/01/2017, the system returns all updates published on or before 01/01/2017.",
      "allowedPattern": "(^$)|^(0[1-9]|1[012])[- \\/.](0[1-9]|[12][0-9]|3[01])[- \\/.]((?:19|20)\\d\\d)$"
    }
  },
  "runtimeConfig": {
    "aws:runPowerShellScript": {
      "properties": [
        {
          "id": "0.aws:runPowerShellScript",
          "timeoutSeconds": "14400",
          "runCommand": [
            "",
            "$zipFilename = 'AWSUpdateWindowsInstance_1_4_4_0.zip'",
            "$zipFileHash = 'CD337ADCFBA463DE895B8D8248A3991940ABB03ADF8525ECA1302385D6A1DDA6'",
            "$moduleName = 'AWSUpdateWindowsInstance'",
            "$tempPath = $env:TEMP",
            "$moduleDirectory = Join-Path $tempPath -ChildPath $moduleName",
            "$moduleZipFilePath = Join-Path $tempPath -ChildPath $zipFilename",
            "$moduleManifestPath = Join-Path $moduleDirectory -ChildPath ('{0}.psd1' -f $moduleName)",
            "$action = '{{ Action }}'",
            "[string[]] $includeList = ('{{ IncludeKbs }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
            "[string[]] $excludeList = ('{{ ExcludeKbs }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
            "[string[]] $categoryList = ('{{ Categories }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
            "[string[]] $severityLevelList = ('{{ SeverityLevels }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
            "[string]$publishedDateAfter = '{{ PublishedDateAfter }}'",
            "[string]$publishedDateBefore = '{{ PublishedDateBefore }}'",
            "[string]$publishedDaysOld = '{{ PublishedDaysOld }}'",
            "[string]$allowReboot = '{{ AllowReboot }}'",
            "",
            "function Main {",
            "  Test-PreCondition",
            "  Clear-WindowsUpdateModule",
            "  Get-WindowsUpdateModule",
            "  Expand-WindowsUpdateModule",
            "  Invoke-WindowsUpdateModule",
            "}",
            "function Test-PreCondition {",
            "  $osversion = [Environment]::OSVersion.Version",
            "  if ($osversion.Major -le 5) {",
            "    Write-Host 'This document is not supported on Windows Server 2003 or earlier.'",
            "    Exit -1",
            "  }",
            "",
            "  if ($osversion.Version -ge '10.0') {",
            "    $sku = (Get-CimInstance -ClassName Win32_OperatingSystem).OperatingSystemSKU",
            "    if ($sku -eq 143 -or $sku -eq 144) {",
            "      Write-Host 'This document is not supported on Windows 2016 Nano Server.'",
            "      Exit -1",
            "    }",
            "  }",
            "",
            "}",
            "",
            "function Clear-WindowsUpdateModule {",
            "  try {",
            "    if (Test-Path $moduleDirectory) {",
            "      Remove-Item $moduleDirectory -Force -Recurse",
            "    }",
            "    if (Test-Path $moduleZipFilePath) {",
            "      Remove-Item $moduleZipFilePath -Force",
            "    }",
            "  } catch {",
            "    Write-Host \"Cleaning Windows update module resulted in error: $($_)\"",
            "  }",
            "}",
            "",
            "function Get-WindowsUpdateModule {",
            "  try {",
            "    $ssmAgentService = Get-ItemProperty 'HKLM:SYSTEM\\CurrentControlSet\\Services\\AmazonSSMAgent\\' -ErrorAction SilentlyContinue",
            "    if($ssmAgentService -and $ssmAgentService.Version -ge '2.0.533.0') {",
            "      $region = $env:AWS_SSM_REGION_NAME",
            "    }",
            "",
            "    if(-not $region) {",
            "      try {",
            "        $identityDocumentUrl = 'http://169.254.169.254/latest/dynamic/instance-identity/document'",
            "        $region = ((Invoke-WebRequest -UseBasicParsing -uri $identityDocumentUrl).Content | ConvertFrom-Json).region",
            "      } catch {",
            "        $region = 'us-east-1'",
            "      }",
            "    }",
            "",
            "    if ($region.StartsWith('cn-')) {",
            "      $s3Location = 'https://s3.{0}.amazonaws.com.cn/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
            "    } elseif($region.StartsWith('us-gov-')) {",
            "      $s3Location = 'https://s3-fips-{0}.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
            "    } elseif($region -eq 'us-east-1') {",
            "      $s3Location = 'https://s3.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
            "    } else {",
            "      $s3Location = 'https://aws-windows-downloads-{0}.s3.amazonaws.com/PSModules/AWSUpdateWindowsInstance/{1}'",
            "    }",
            "",
            "    $source = $s3Location -f $region, $zipFilename",
            "    $moduleLocalPath = Join-Path $tempPath -ChildPath $zipFilename",
            "    Start-BitsTransfer -Source $source -Destination $moduleLocalPath",
            "",
            "    $fileStream = New-Object System.IO.FileStream($moduleLocalPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)",
            "    $sha256 = [System.Security.Cryptography.HashAlgorithm]::Create('System.Security.Cryptography.SHA256CryptoServiceProvider')",
            "    $currentHash = [System.BitConverter]::ToString($sha256.ComputeHash($fileStream), 0).Replace('-', '').ToLowerInvariant()",
            "    $sha256.Dispose()",
            "    $fileStream.Dispose()",
            "",
            "    if ($currentHash -ne $zipFileHash) {",
            "      Write-Host 'The SHA hash of the module does not match the expected value.'",
            "      Exit -1",
            "    }",
            "  } catch {",
            "    Write-Host ('Error encountered while getting the module: {0}.' -f $_.Exception.Message)",
            "    Exit -1",
            "  }",
            "}",
            "",
            "function Expand-WindowsUpdateModule {",
            "  try {",
            "    [System.Reflection.Assembly]::LoadWithPartialName('System.IO.Compression.FileSystem') | Out-Null",
            "    $zip = [System.IO.Compression.ZipFile]::OpenRead($moduleZipFilePath)",
            "    foreach ($item in $zip.Entries) {",
            "      $extractPath = Join-Path $tempPath -ChildPath $item.FullName",
            "      if ($item.Length -eq 0) {",
            "        if (-not (Test-Path $extractPath)) {",
            "          New-Item $extractPath -ItemType Directory | Out-Null",
            "        }",
            "      } else {",
            "        $parentPath = Split-Path $extractPath",
            "        if (-not (Test-Path $parentPath)) {",
            "          New-Item $parentPath -ItemType Directory | Out-Null",
            "        }",
            "        [System.IO.Compression.ZipFileExtensions]::ExtractToFile($item, $extractPath, $true)",
            "      }",
            "    }",
            "  } catch {",
            "    Write-Host ('Error encountered when extracting module file: {0}.' -f $_.Exception.Message)",
            "    Exit -1",
            "  } finally {",
            "    $zip.Dispose()",
            "  }",
            "}",
            "",
            "function Invoke-WindowsUpdateModule {",
            "  Import-Module $moduleManifestPath",
            "  try {",
            "    $root = $PSScriptRoot.Split('\\')",
            "    $runCommandId = $root[$root.Count - 3]",
            "  } catch {",
            "    Write-Host ('Error encountered when obtaining the run command id: {0}.' -f $_.Exception.Message)",
            "    Exit -1",
            "  }",
            "  $command = 'Install-AwsUwiWindowsUpdates -Id $runCommandId'",
            "  if ($action -ieq 'Scan') { $command += ' -ListOnly' }",
            "  if ($includeList) { $command += ' -IncludeKbs $($includeList)' }",
            "  if ($excludeList) { $command += ' -ExcludeKbs $($excludeList)' }",
            "  if ($categoryList) { $command += ' -Categories $($categoryList)' }",
            "  if ($severityLevelList) { $command += ' -SeverityLevel $($severityLevelList)' }",
            "  if ($publishedDateAfter) { $command += ' -PublishedDateAfter $($publishedDateAfter)' }",
            "  if ($publishedDateBefore) { $command += ' -PublishedDateBefore $($publishedDateBefore)' }",
            "  if ($publishedDaysOld) { $command += ' -PublishedDaysOld $([int]$publishedDaysOld)' }",
            "  if ($allowReboot -ieq 'False') { $command += ' -NoReboot' }",
            "  Invoke-Expression $command",
            "}",
            "",
            "Main"
          ]
        }
      ]
    }
  }
}
