{
  "schemaVersion": "0.3",
  "description": "The AWSSupport-ManageRDPSettings automation document allows the user to manage common Remote Desktop Protocol (RDP) settings, such as the RDP port and Network Layer Authentication (NLA). By default, the document reads and outputs the values of the settings. IMPORTANT: Changes to the RDP settings should be carefully reviewed before running this document.",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "parameters": {
    "InstanceId": {
      "type": "String",
      "description": "(Required) The ID of the managed instance to manage the RDP settings of.",
      "allowedPattern": "^[m]{0,1}i-[a-z0-9]{8,17}$"
    },
    "RDPPortAction": {
      "type": "String",
      "description": "(Required) An action to apply to the RDP port: Check, Modify.",
      "default": "Check",
      "allowedValues": [
        "Check",
        "Modify"
      ]
    },
    "RDPPort": {
      "type": "String",
      "description": "(Optional) Specify the new RDP port. Used only when the action is set to Modify. The port number must be between 1025-65535. Note: After the port is changed, the RDP service is restarted.",
      "default": "3389",
      "allowedPattern": "^(102[5-9]|1[0-9][3-9][0-9]|[2-9][0-9]{3}|[1-5][0-9]{4}|6[0-5][0-5][0-3][0-5])$"
    },
    "NLASettingAction": {
      "type": "String",
      "description": "(Required) An action to perform on the NLA setting: Check, Enable, Disable.",
      "default": "Check",
      "allowedValues": [
        "Check",
        "Enable",
        "Disable"
      ]
    },
    "RemoteConnections": {
      "type": "String",
      "description": "(Required) An action to perform on the fDenyTSConnections setting: Check, Enable, Disable.",
      "default": "Check",
      "allowedValues": [
        "Check",
        "Enable",
        "Disable"
      ]
    },
    "AutomationAssumeRole": {
      "type": "String",
      "description": "(Optional) The IAM role for this execution. If no role is specified, AWS Systems Manager Automation will use the permissions of the user that executes this document.",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "name": "assertInstanceIsWindows",
      "action": "aws:assertAwsResourceProperty",
      "onFailure": "Abort",
      "inputs": {
        "Service": "ec2",
        "Api": "DescribeInstances",
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "PropertySelector": "$.Reservations[0].Instances[0].Platform",
        "DesiredValues": [
          "windows"
        ]
      },
      "isCritical": "true",
      "nextStep": "assertInstanceIsManagedInstance"
    },
    {
      "name": "assertInstanceIsManagedInstance",
      "action": "aws:assertAwsResourceProperty",
      "onFailure": "Abort",
      "inputs": {
        "Service": "ssm",
        "Api": "DescribeInstanceInformation",
        "InstanceInformationFilterList": [
          {
            "key": "InstanceIds",
            "valueSet": [
              "{{ InstanceId }}"
            ]
          }
        ],
        "PropertySelector": "$.InstanceInformationList[0].PingStatus",
        "DesiredValues": [
          "Online"
        ]
      },
      "isCritical": "true",
      "nextStep": "manageRDPSettings"
    },
    {
      "name": "manageRDPSettings",
      "action": "aws:runCommand",
      "onFailure": "Abort",
      "inputs": {
        "DocumentName": "AWS-RunPowerShellScript",
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "Function Get-RDPPort {",
            "",
            "    $registryKey = \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Termin*Server\\WinStations\\RDP*CP\\\"",
            "    $checkRdpPath = (Test-Path -Path $registryKey)",
            "",
            "    if ($checkRdpPath) {",
            "",
            "        $checkRdpPort = (Get-ItemProperty -Path $registryKey -Name PortNumber -ErrorAction SilentlyContinue).portnumber",
            "",
            "        if ($null -ne $checkRdpPort) {",
            "",
            "            return $checkRdpPort",
            "            ",
            "        }",
            "        else {",
            "",
            "            throw \"PortNumber property does not exist.\"",
            "",
            "        }",
            "",
            "    }",
            "    else {",
            "",
            "        throw \"Registry subkey path does not exist.\"",
            "",
            "    }",
            "",
            "}",
            "",
            "Function Set-RDPPort {",
            "    Param (",
            "        [Parameter(Mandatory = $true)]",
            "        [ValidateRange(1025, 65535)]",
            "        [String]$Port",
            "    )",
            "",
            "    try {",
            "        ",
            "        if ((Get-RDPPort) -eq $Port) {",
            "",
            "            Write-Host \"RDP Port is already set to $Port.\"",
            "",
            "        }",
            "        else {     ",
            "",
            "            #Check to see if there is anything listening on this port before changing the port.",
            "            $checkListeningPort = & \"${env:SYSTEMROOT}\\system32\\netstat.exe\" -nab | Select-String -Pattern \":$Port \" -Context 1",
            "",
            "            if (-not $checkListeningPort) {",
            "",
            "                $registryKey = \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Termin*Server\\WinStations\\RDP*CP\\\"",
            "                Set-ItemProperty -Path $registryKey -Name PortNumber -Value $Port -ErrorAction Stop",
            "                Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue",
            "                Write-Host \"RDP port set to $(Get-RDPPort). Make sure your AWS Security Group and Windows firewall allow traffic on the new port. To learn about Amazon EC2 Security Group, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html.\" ",
            "",
            "            }  ",
            "            else {",
            "",
            "                throw \"Unable to change RDP port to $Port. Port is already in use.\"",
            "",
            "            }",
            "            ",
            "        }",
            "",
            "    }",
            "    catch {",
            "",
            "        throw \"$($_.Exception.Message)\"",
            "",
            "    }",
            "",
            "}",
            "",
            "Function Get-NLASetting {",
            "",
            "    #Get NLA setting status. The output of the WMI command is 0 (Disabled) or 1 (Enabled).",
            "    $nlaStatus = (Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\\cimv2\\terminalservices -Filter \"TerminalName='RDP-tcp'\").UserAuthenticationRequired",
            "",
            "    if ($nlaStatus -eq \"0\") {",
            "",
            "        return \"Network Level Authentication is disabled on this machine.\"",
            "",
            "    }",
            "    else {",
            "",
            "        return \"Network Level Authentication is enabled on this machine.\"",
            "",
            "    }",
            "    ",
            "}",
            "",
            "Function Set-NLASetting {",
            "    Param (",
            "        [Parameter(Mandatory = $true)]",
            "        [ValidateSet(\"Enable\", \"Disable\")] ",
            "        [String]$Action",
            "    )",
            "",
            "    if ($Action -eq \"Enable\") {",
            "        ",
            "        #SetUserAuthenticationRequired(1) (Enabled)",
            "        (Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\\cimv2\\terminalservices -Filter \"TerminalName='RDP-tcp'\").SetUserAuthenticationRequired(1) | Out-Null",
            "        Write-Host \"Network Level Authentication enabled.\"",
            "",
            "    }",
            "    else {",
            "",
            "        #SetUserAuthenticationRequired(0) (Disabled)",
            "        (Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\\cimv2\\terminalservices -Filter \"TerminalName='RDP-tcp'\").SetUserAuthenticationRequired(0) | Out-Null",
            "        Write-Host \"Network Level Authentication disabled.\"",
            "",
            "    }",
            "   ",
            "}",
            "",
            "Function Get-RemoteConnectionsSetting{",
            "",
            "    #Get the current status of the fDenyTSConnections Registry Property from the registry location HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server",
            "    $registryKey = \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Termin*Server\\\"",
            "    $checkRemoteConnectionsPath = (Test-Path -Path $registryKey)",
            "",
            "    if ($checkRemoteConnectionsPath) {",
            "",
            "        $checkRemoteConnections = (Get-ItemProperty -Path $registryKey -Name fDenyTSConnections -ErrorAction SilentlyContinue).fDenyTSConnections",
            "",
            "        if ($null -ne $checkRemoteConnections) {",
            "",
            "            if ($checkRemoteConnections -eq \"0\") {",
            "",
            "                return \"Remote Desktop connections are enabled on this machine.\"",
            "        ",
            "            }",
            "            else {",
            "        ",
            "                return \"Remote Desktop connections are disabled on this machine.\"",
            "        ",
            "            }",
            "            ",
            "        }",
            "        else {",
            "",
            "            throw \"fDenyTSConnections property does not exist.\"",
            "",
            "        }",
            "",
            "    }",
            "    else {",
            "",
            "        throw \"Registry subkey path does not exist.\"",
            "    }",
            "",
            "}",
            "",
            "Function Set-RemoteConnectionsSetting {",
            "    Param (",
            "        [Parameter(Mandatory = $true)]",
            "        [ValidateSet(\"Enable\", \"Disable\")] ",
            "        [String]$Value",
            "    )",
            "",
            "    try {",
            "",
            "        #Set the desired status of the fDenyTSConnections Registry Property from the registry location HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server",
            "        $registryKey = \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Termin*Server\\\"",
            "        ",
            "        if ($Value -eq \"Enable\") {",
            "",
            "            #fDenyTSConnections set to 0 (Enabled)",
            "            Set-ItemProperty -Path $registryKey -Name fDenyTSConnections -Value 0 -ErrorAction Stop",
            "            Write-Host \"Remote Desktop connections enabled.\"",
            "",
            "        }",
            "        else {",
            "",
            "            #fDenyTSConnections set to 1 (Disabled)",
            "            Set-ItemProperty -Path $registryKey -Name fDenyTSConnections -Value 1 -ErrorAction Stop",
            "            Write-Host \"Remote Desktop connections disabled.\"",
            "",
            "        }",
            "            ",
            "    }",
            "    catch {",
            "",
            "        throw \"Error accessing $registryKey : $($_.Exception.Message)\"",
            "",
            "    }",
            "",
            "}",
            "",
            "try {",
            "",
            "    $rdpPortSettingAction = \"{{ RDPPortAction  }}\"",
            "    $rdpPort = \"{{ RDPPort }}\"",
            "    $nlaSettingAction = \"{{ NLASettingAction }}\"",
            "    $remoteConnectionsAction = \"{{ RemoteConnections }}\"",
            "",
            "    if ($rdpPortSettingAction -eq \"Check\") {",
            "        ",
            "        Write-Host \"Current RDP Port: $(Get-RDPPort).\"",
            "",
            "    }",
            "    else {",
            "      ",
            "        Set-RDPPort -Port $rdpPort",
            "",
            "    }",
            "",
            "    if ($nlaSettingAction -eq \"Check\") {",
            "        ",
            "        Get-NLASetting",
            "",
            "    }",
            "    else {",
            "",
            "        Set-NLASetting -Action $nlaSettingAction",
            "",
            "    }",
            "",
            "    if ($remoteConnectionsAction -eq \"Check\") {",
            "",
            "        Get-RemoteConnectionsSetting",
            "        ",
            "    }",
            "    else {",
            "",
            "        Set-RemoteConnectionsSetting -Value $remoteConnectionsAction",
            "",
            "    }",
            "",
            "}",
            "catch {",
            "",
            "    Write-Host $_.Exception.Message",
            "    Exit 1   ",
            "",
            "}"
          ]
        }
      },
      "isCritical": "true",
      "isEnd": "true"
    }
  ],
  "outputs": [
    "manageRDPSettings.Output"
  ]
}
